<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function ($scope) {
	var c = $scope.data.categories;
	var d = $scope.data.documents;
	c.forEach(function(cat) {
		cat.documents = [];
		d.forEach(function(doc) {
			if (doc.topCat == cat.sys_id) 
				cat.documents.push(doc);
		})
	})
}

sp.Util.addInfoMessage("Wait!!");]]></client_script>
        <controller_as>c</controller_as>
        <css>.categories{
margin-left: 16px;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>my_kb_view</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>My Kb View</name>
        <option_schema/>
        <public>true</public>
        <roles/>
        <script><![CDATA[var kb = $sp.getValue("kb_knowledge_base");  // portal catalog
data.kb = kb;
data.canReadArticles = false; 
var gr = new GlideRecord('kb_knowledge_base');
gr.get(kb);
data.kb_title = gr.getDisplayValue();
$sp.getRecordValues(data, gr, 'title,description');
data.categories = getCategories(kb);
data.documents = getDocuments(kb);
data.filterMsg = gs.getMessage("Filter...");

function getDocuments(kb) {
	var d = [];
	var gr = new GlideRecordSecure('kb_knowledge');
	gr.addQuery('kb_knowledge_base', kb);
	gr.addQuery('workflow_state', 'published');
	gr.addQuery('valid_to', '>=', (new GlideDate()).getLocalDate().getValue());
	gr.orderBy('short_description');
	gr.query();
	while (gr.next()) {
		var n = {};
		$sp.getRecordValues(n, gr, 'sys_id,number,short_description,kb_category');
		n.topCat = $sp.getKBTopCategoryID(n.kb_category);
		d.push(n);
	}
	if (d.length)
		data.canReadArticles = true;
	return d;
}

function getCategories(id) {
	var c = [];
	addCategories(c, id);
	return c;
}

function addCategories(c, id) {
	var gr = new GlideRecord('kb_category');
	gr.addQuery('parent_id', id);
	gr.orderBy('label');
	gr.query();
	while (gr.next()) {
		var n = {};
		$sp.getRecordValues(n, gr, 'sys_id,label,value,parent_id');
		c.push(n);
		//addCategories(c, gr.getValue('sys_id'));
	}
}]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-11-28 06:17:31</sys_created_on>
        <sys_id>6bece55997323110e4833dafe153afa3</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>My Kb View</sys_name>
        <sys_package display_value="CreateNotes" source="x_snc_createnotes">df5fd9a5090232007f44e1046c8ff69f</sys_package>
        <sys_policy/>
        <sys_scope display_value="CreateNotes">df5fd9a5090232007f44e1046c8ff69f</sys_scope>
        <sys_update_name>sp_widget_6bece55997323110e4833dafe153afa3</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2023-11-28 06:23:51</sys_updated_on>
        <template><![CDATA[<div>
  <div ng-show="false" class="col-md-12"><input ng-model="kb_view_filter" placeholder="{{data.filterMsg}}"/></div>
  <h4 ng-if="data.canReadArticles" class="wrapper-md text-center">{{data.kb_title}}</h4>
  <div ng-if="!data.canReadArticles" class="categories">
    ${No categories available}
  </div>
  <div class="col-md-3 col-sm-4 col-xs-6" ng-show="filtered.length > 0" ng-repeat="cat in data.categories" ng-if="cat.documents.length">
    <a href="?id=kb_category&kb_category={{cat.sys_id}}">
      <div class="panel panel-default" style="height:120px;overflow:auto;word-break:break-word">
        <h4 class="text-center"  style="vertical-align:middle">{{cat.label}}</h4>
        <div ng-if="filtered.length != 1" class="small text-center">${{{filtered.length}} articles}</div>
        <div ng-if="filtered.length == 1" class="small text-center">${{{filtered.length}} article}</div>
        <div ng-show="false" ng-repeat="doc in filtered = (cat.documents | filter : kb_view_filter)">
        </div>
      </div>
    </a>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
